doctype html
html(ng-app="admin")
head
	title= 'Viajes Transparentes'
	link(rel='stylesheet', href='/css/bootstrap.min.css')
	link(rel='stylesheet', href='/css/flat-ui.min.css')
	link(rel='stylesheet', href='/css/style.css')
body.ar-adm(ng-controller="AdminController")
	#user_panel.ar-panel(ng-class="{aractive:currentPanel=='user_panel'}")
		.ar-advice Por ahora, el panel no cuenta con la opción "recordarme", por lo que si esta pestaña se cierra, deberá volver proporcionar su contraseña, próximamente esto cambiará
		h2 Nuevo viaje
		form.login-form(ng-submit="login()")
	#login_panel.ar-panel(ng-class="{aractive:currentPanel=='login_panel'}")
		.ar-advice(class="{{ui_adv}}") Datos incorrectos
		.login-block
			h4 Iniciar Sesión
			form.login-form(name="login_form" ng-submit="login()" method="POST")
				.form-group
					input.form-control.login-field(type="text" value="" ng-model="email" name="email" placeholder= "Correo Electrónico" required autofocus)
					label.login-field-icon.fui-user(for="login-name")
				.form-group
					input.form-control.login-field(type="password" value="" ng-model="password" placeholder="Contraseña" name="password")
					label.login-field-icon.fui-lock(for="login-pass")
				input.btn.btn-primary.btn-large.btn-block(type="submit" href="#" value="Iniciar")
				a.login-link(href="#") Recuperar contraseña
		


	script(src='/js/angular.min.js')
	script(src='/js/sha256.js')
	script.
		(function(){
			var app = angular.module('admin',[])
			.controller('AdminController', function($http, $scope, $q, $timeout){

				$scope.currentPanel = 'login_panel';
				$scope.ui_adv = '';

				$scope.navigateTo = function(panel){
					$scope.currentPanel = panel;
				};

				//check if logged
				console.log(document.cookie);
				try{
					var ss = JSON.parse(document.cookie);
					$scope.navigateTo('user_panel');
				} catch(e){
					//not logged
					console.log('not logged in');
				}
				
				$scope.login = function(){
					var email = Sha256.hash($scope.email),
						pass  = Sha256.hash($scope.password),
						start = Date.now(),
						accesstoken = Sha256.hash(pass+start);

					$http.get( '/users/'+email+credentials(email,accesstoken,start) )
						.then(
							function(response) { 
								var res = response.data;
								console.log(res);
								if(res.status== "success"){
									$scope.navigateTo('user_panel');
									var d = new Date();
									d.setTime(d.getTime() + (6*24*60*60*1000));
									var expires = d.toUTCString();
									document.cookie='{"publickey":"'+email+'","expires":"'+expires+'"}';
								} else if (res.status == 'error'){
									$scope.ui_adv = 'ar-in';
									setTimeout(function(){ 
										$scope.$apply(function(){
											$scope.ui_adv = 'ar-out';											
										});
									 },1500);
								}
							}, 
								function(what){ alert('Ocurrió un problema, intente de nuevo'); }
							);
				};
				
				function credentials(publickey,accesstoken,data){
					if(data) return '?publickey='+publickey+'&accesstoken='+accesstoken+'&data='+data;
					else	 return '?publickey='+publickey+'&accesstoken='+accesstoken;
				}				

			});
		})()
